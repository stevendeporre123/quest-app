<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <title>Quest â€“ Upload</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">Quest</div>
    <nav class="nav-links">
      <a href="/" class="active">Uploaden</a>
      <a href="#meetings">Vergaderingen</a>
      <a href="#councillors">Raadsleden</a>
      <button type="button" class="nav-btn" id="openMeetingBtn">Open vergaderingâ€¦</button>
    </nav>
  </header>

  <main id="main-content">
    <section class="card">
      <p class="eyebrow">Stap 1</p>
      <h1 class="page-title">Upload Agenda & Transcript</h1>
      <p class="muted">Kies het XML-agendapunt en de bijhorende VTT-transcriptie. Optioneel kan je een webcast-ID toevoegen.</p>

      <form id="uploadForm" enctype="multipart/form-data">
        <label>
          Agenda.xml
          <input type="file" name="agenda" accept=".xml" required>
        </label>

        <label>
          Transcript.vtt
          <input type="file" name="transcript" accept=".vtt" required>
        </label>

        <label>
          Webcast ID
          <input type="text" name="webcast_id" placeholder="bv. stadgent_20250210_2">
        </label>

        <button type="submit" class="primary-btn">Verwerken</button>
      </form>
    </section>

    <section class="card" id="help">
      <p class="eyebrow">Hoe werkt het?</p>
      <h2>Van upload tot overzicht</h2>
      <ol class="steps">
        <li>Selecteer de agenda en transcriptie en klik op <strong>Verwerken</strong>.</li>
        <li>De AI service koppelt de vragen aan de transcriptie en slaat ze op in de database.</li>
        <li>Na afloop verschijnt een link naar het vergaderingsoverzicht en kan je tijden bijsturen.</li>
      </ol>
    </section>

    <section class="card" id="resultCard" hidden>
      <div class="result-header">
        <span class="status-pill" id="uploadStatus" data-state="idle">Status</span>
        <a id="meetingLink" class="ghost-btn" href="#" hidden>Ga naar vergadering</a>
      </div>
      <pre id="result">{}</pre>
    </section>

    <section class="card" id="meetings">
      <div class="card-header">
        <div>
          <p class="eyebrow">Overzicht</p>
          <h2>Recente vergaderingen</h2>
        </div>
        <p class="muted">Klik op een vergadering voor details of gebruik het meeting-ID.</p>
      </div>
      <div class="table-wrapper">
        <table id="meetings-table">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Commissie</th>
              <th>Webcast ID</th>
              <th>Vragen</th>
              <th>Status</th>
              <th>Acties</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="meeting-empty" id="meetings-empty" hidden>Nog geen vergaderingen opgeslagen.</p>
    </section>

    <section class="card" id="processing-card">
      <div class="card-header">
        <div>
          <p class="eyebrow">Realtime status</p>
          <h2>Verwerkingsqueue</h2>
        </div>
        <p class="muted" id="queue-summary">Geen lopende taken.</p>
      </div>
      <div class="table-wrapper">
        <table id="queue-table">
          <thead>
            <tr>
              <th>Vergadering</th>
              <th>Wachtrij</th>
              <th>Bezig</th>
              <th>Fouten</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="meeting-empty" id="queue-empty" hidden>Geen wachtrij. ðŸŽ‰</p>
    </section>

    <section class="card" id="councillors">
      <div class="card-header">
        <div>
          <p class="eyebrow">Raadsleden</p>
          <h2>Beheer namen & titels</h2>
        </div>
        <p class="muted">Gebruik deze lijst om naamvarianten in antwoorden consistent te houden.</p>
      </div>
      <div class="table-wrapper">
        <table id="councillors-table">
          <thead>
            <tr>
              <th>Voornaam</th>
              <th>Achternaam</th>
              <th>Naam met titel</th>
              <th>Foute schrijfwijzen</th>
              <th>Acties</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="meeting-empty" id="councillors-empty" hidden>Geen raadsleden beschikbaar.</p>
    </section>
  </main>

  <script>
    const form = document.getElementById('uploadForm');
    const result = document.getElementById('result');
    const resultCard = document.getElementById('resultCard');
    const meetingLink = document.getElementById('meetingLink');
    const statusPill = document.getElementById('uploadStatus');
    const meetingBtn = document.getElementById('openMeetingBtn');
    const queueSummary = document.getElementById('queue-summary');

    function formatMeetingStatus(meeting) {
      const state = (meeting.processing_state || '').toLowerCase() || 'pending';
      const totalQuestions = Number(meeting.total_questions ?? meeting.question_count ?? 0) || 0;
      const processed = Number(meeting.processed_questions ?? 0) || 0;
      const labels = {
        completed: 'Klaar',
        processing: 'Bezig',
        pending: 'Wacht',
        queued: 'In wachtrij',
        error: 'Fout'
      };
      const label = labels[state] || 'Onbekend';
      const progress = totalQuestions ? `${Math.min(processed, totalQuestions)}/${totalQuestions}` : `${processed}`;
      return { state, label, progress };
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);

      resultCard.hidden = false;
      meetingLink.hidden = true;
      statusPill.dataset.state = 'working';
      statusPill.textContent = 'Verwerkenâ€¦';
      result.textContent = 'Bestanden uploadenâ€¦';

      try {
        const res = await fetch('/api/upload', {
          method: 'POST',
          body: fd
        });
        const data = await res.json();
        result.textContent = JSON.stringify(data, null, 2);

        if (res.ok) {
          if (data.status === 'completed') {
            statusPill.dataset.state = 'ok';
            statusPill.textContent = 'Klaar';
          } else {
            statusPill.dataset.state = 'working';
            statusPill.textContent = 'Verwerking gestart';
          }
          loadMeetings();
          loadQueue();
        } else {
          statusPill.dataset.state = 'error';
          statusPill.textContent = 'Mislukt';
        }

        if (data.meeting_id) {
          meetingLink.hidden = false;
          meetingLink.href = `/meeting/${data.meeting_id}`;
          meetingLink.textContent = `Ga naar vergadering #${data.meeting_id}`;
        }
      } catch (err) {
        statusPill.dataset.state = 'error';
        statusPill.textContent = 'Fout';
        result.textContent = err.message;
      }
    });

    meetingBtn?.addEventListener('click', () => {
      const id = prompt('Geef het meeting-ID in dat je wil openen:');
      if (id) {
        window.location.href = `/meeting/${id.trim()}`;
      }
    });

    async function loadMeetings() {
      const res = await fetch('/api/meetings');
      const tbody = document.querySelector('#meetings-table tbody');
      const empty = document.getElementById('meetings-empty');

      if (!res.ok) {
        empty.hidden = false;
        empty.textContent = 'Kon vergaderingen niet laden.';
        return;
      }

      const data = await res.json();
      tbody.innerHTML = '';

      if (!data.meetings.length) {
        empty.hidden = false;
        return;
      }

      empty.hidden = true;

      data.meetings.forEach(m => {
        const statusInfo = formatMeetingStatus(m);
        const totalQuestions = Number(m.total_questions ?? m.question_count ?? 0) || 0;
        const processedQuestions = Number(m.processed_questions ?? 0) || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.meeting_date || ''}</td>
          <td>${m.commission_name || ''}</td>
          <td>${m.webcast_id || '-'}</td>
          <td>${totalQuestions ? `${processedQuestions}/${totalQuestions}` : processedQuestions}</td>
          <td>
            <span class="status-pill" data-state="${statusInfo.state}">
              ${statusInfo.label}${statusInfo.progress ? ` (${statusInfo.progress})` : ''}
            </span>
          </td>
          <td class="table-actions">
            <a class="detail-link" href="/meeting/${m.id}">Details</a>
            <button type="button" class="danger-btn delete-meeting" data-id="${m.id}">Verwijder</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    loadMeetings();
    async function loadQueue() {
      const tbody = document.querySelector('#queue-table tbody');
      const empty = document.getElementById('queue-empty');
      try {
        const res = await fetch('/api/processing/queue');
        if (!res.ok) throw new Error('Queue request failed');
        const data = await res.json();
        const list = data.meetings || [];
        tbody.innerHTML = '';
        if (!list.length) {
          empty.hidden = false;
          queueSummary.textContent = 'Geen openstaande taken.';
        } else {
          empty.hidden = true;
          list.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>#${item.meeting_id} â€“ ${item.meeting_date || ''}</td>
              <td>${item.queued || 0}</td>
              <td>${item.in_progress || 0}</td>
              <td>${item.errors || 0}</td>
            `;
            tbody.appendChild(tr);
          });
          const waiting = list.reduce((sum, item) => sum + (item.queued || 0), 0);
          const running = list.reduce((sum, item) => sum + (item.in_progress || 0), 0);
          const errorCount = list.reduce((sum, item) => sum + (item.errors || 0), 0);
          queueSummary.textContent = `${waiting} wachtend, ${running} bezig${errorCount ? `, ${errorCount} fouten` : ''}.`;
        }
        if (data.queue && typeof data.queue.queued_in_memory === 'number') {
          queueSummary.textContent += ` (buffer: ${data.queue.queued_in_memory})`;
        }
      } catch (err) {
        queueSummary.textContent = 'Kon queue niet laden.';
      }
    }

    loadQueue();
    setInterval(() => {
      loadMeetings();
      loadQueue();
    }, 10000);

    document.getElementById('meetings-table').addEventListener('click', async (e) => {
      const btn = e.target.closest('.delete-meeting');
      if (!btn) return;
      const meetingId = btn.dataset.id;
      if (!confirm(`Vergadering #${meetingId} verwijderen?`)) {
        return;
      }
      btn.disabled = true;
      btn.textContent = '...';
      const res = await fetch(`/api/meetings/${meetingId}`, { method: 'DELETE' });
      if (!res.ok) {
        alert('Verwijderen mislukt.');
      } else {
        loadMeetings();
      }
    });

    async function loadCouncillors() {
      const res = await fetch('/api/councillors');
      const tbody = document.querySelector('#councillors-table tbody');
      const empty = document.getElementById('councillors-empty');

      if (!res.ok) {
        empty.hidden = false;
        empty.textContent = 'Kon raadsleden niet laden.';
        return;
      }

      const data = await res.json();
      const list = data.councillors || [];
      tbody.innerHTML = '';

      const newRow = document.createElement('tr');
      newRow.dataset.id = 'new';
      newRow.innerHTML = `
        <td><input name="given_name" placeholder="Voornaam"></td>
        <td><input name="family_name" placeholder="Achternaam"></td>
        <td><input name="name_with_title" placeholder="bv. schepen Janssens"></td>
        <td><input name="wrong_spellings" placeholder="Naamvarianten"></td>
        <td><button class="save-btn" data-action="create">Toevoegen</button></td>
      `;
      tbody.appendChild(newRow);

      list.forEach(c => {
        const tr = document.createElement('tr');
        tr.dataset.id = c.id;
        tr.innerHTML = `
          <td><input name="given_name" value="${c.given_name || ''}"></td>
          <td><input name="family_name" value="${c.family_name || ''}"></td>
          <td><input name="name_with_title" value="${c.name_with_title || ''}"></td>
          <td><input name="wrong_spellings" value="${c.wrong_spellings || ''}"></td>
          <td class="table-actions">
            <button class="save-btn" data-action="save">Opslaan</button>
            <button class="danger-btn" data-action="delete">Verwijder</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      empty.hidden = list.length > 0;
    }

    loadCouncillors();

    document.getElementById('councillors-table').addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const action = btn.dataset.action;
      const row = btn.closest('tr');
      if (!action || !row) return;

      const payload = {};
      row.querySelectorAll('input').forEach(inp => {
        payload[inp.name] = inp.value.trim();
      });

      btn.disabled = true;
      const originalText = btn.textContent;

      try {
        if (action === 'create') {
          btn.textContent = 'Toevoegenâ€¦';
          const res = await fetch('/api/councillors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error('Mislukt');
        } else if (action === 'save') {
          btn.textContent = 'Opslaanâ€¦';
          const id = row.dataset.id;
          const res = await fetch(`/api/councillors/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error('Mislukt');
        } else if (action === 'delete') {
          const id = row.dataset.id;
          if (!confirm('Deze persoon verwijderen?')) return;
          btn.textContent = 'Verwijderenâ€¦';
          const res = await fetch(`/api/councillors/${id}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('Mislukt');
        }
        loadCouncillors();
      } catch (err) {
        alert(err.message || 'Bewerking mislukt.');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });
  </script>
</body>
</html>
