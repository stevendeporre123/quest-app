<!doctype html>
<html lang="nl">

<head>
  <meta charset="utf-8">
  <title>Quest &ndash; Taxonomie</title>
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>
  <header class="topbar">
    <div class="brand">Quest</div>
    <nav class="nav-links">
      <a href="/">Uploaden</a>
      <a href="/#meetings">Vergaderingen</a>
      <a href="/questions">Zoekvragen</a>
      <a href="/councillors">Raadsleden</a>
      <a href="/taxonomy" class="active">Taxonomie</a>
    </nav>
  </header>

  <main id="main-content">
    <section class="card">
      <div class="card-header">
        <div>
          <p class="eyebrow">Topics</p>
          <h1 class="page-title">Taxonomiebeheer</h1>
        </div>
        <p class="muted">Definieer labels, parent-relaties en synoniemen die de AI moet gebruiken.</p>
      </div>
      <div class="table-wrapper">
        <table id="taxonomy-table">
          <thead>
            <tr>
              <th>Label</th>
              <th>Parent</th>
              <th>Prioriteit</th>
              <th>Synoniemen</th>
              <th>Acties</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="meeting-empty" id="taxonomy-empty" hidden>Geen labels geconfigureerd.</p>
    </section>
  </main>

  <script>
    function htmlEscape(value) {
      if (value === null || value === undefined) return '';
      return String(value).replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[ch]));
    }

    function buildParentOptions(nodes, excludeId = null, selectedId = null) {
      const options = ['<option value="">Geen</option>'];
      nodes.forEach(node => {
        if (excludeId && Number(node.id) === Number(excludeId)) {
          return;
        }
        const selected = Number(node.id) === Number(selectedId) ? 'selected' : '';
        options.push(`<option value="${node.id}" ${selected}>${htmlEscape(node.label)}</option>`);
      });
      return options.join('');
    }

    async function loadTaxonomy() {
      const tbody = document.querySelector('#taxonomy-table tbody');
      const empty = document.getElementById('taxonomy-empty');
      try {
        const res = await fetch('/api/taxonomy');
        if (!res.ok) throw new Error('Kon taxonomie niet laden.');
        const data = await res.json();
        const list = data.taxonomy || [];
        tbody.innerHTML = '';

        const createRow = document.createElement('tr');
        createRow.dataset.id = 'new';
        createRow.innerHTML = `
          <td><input name="label" placeholder="Label"></td>
          <td>
            <select name="parent_id">
              ${buildParentOptions(list)}
            </select>
          </td>
          <td><input name="priority" type="number" value="0"></td>
          <td><input name="synonyms" placeholder="synoniem1, synoniem2"></td>
          <td><button class="save-btn" data-action="create">Toevoegen</button></td>
        `;
        tbody.appendChild(createRow);

        list.forEach(node => {
          const tr = document.createElement('tr');
          tr.dataset.id = node.id;
          const synonymValue = (node.synonyms || []).join(', ');
          tr.innerHTML = `
            <td><input name="label" value="${htmlEscape(node.label)}"></td>
            <td>
              <select name="parent_id">
                ${buildParentOptions(list, node.id, node.parent_id)}
              </select>
            </td>
            <td><input name="priority" type="number" value="${node.priority || 0}"></td>
            <td><input name="synonyms" value="${htmlEscape(synonymValue)}"></td>
            <td class="table-actions">
              <button class="save-btn" data-action="save">Opslaan</button>
              <button class="danger-btn" data-action="delete">Verwijder</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        empty.hidden = list.length > 0;
      } catch (err) {
        empty.hidden = false;
        empty.textContent = err.message || 'Kon taxonomie niet laden.';
      }
    }

    document.getElementById('taxonomy-table').addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const action = btn.dataset.action;
      const row = btn.closest('tr');
      if (!action || !row) return;
      const formData = {};
      row.querySelectorAll('input, select').forEach(inp => {
        formData[inp.name] = inp.value;
      });
      const payload = {
        label: formData.label?.trim(),
        parent_id: formData.parent_id ? Number(formData.parent_id) : null,
        priority: formData.priority ? Number(formData.priority) : 0,
        synonyms: (formData.synonyms || '')
          .split(',')
          .map(val => val.trim())
          .filter(Boolean)
      };
      btn.disabled = true;
      const originalText = btn.textContent;
      try {
        if (action === 'create') {
          const res = await fetch('/api/taxonomy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.error || 'Toevoegen mislukt.');
          }
        } else if (action === 'save') {
          const id = row.dataset.id;
          const res = await fetch(`/api/taxonomy/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.error || 'Opslaan mislukt.');
          }
        } else if (action === 'delete') {
          const id = row.dataset.id;
          if (!confirm('Dit label verwijderen?')) return;
          const res = await fetch(`/api/taxonomy/${id}`, { method: 'DELETE' });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.error || 'Verwijderen mislukt.');
          }
        }
        await loadTaxonomy();
      } catch (err) {
        alert(err.message || 'Bewerking mislukt.');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });

    loadTaxonomy();
  </script>
</body>

</html>
